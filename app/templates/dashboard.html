{% extends "base.html" %}

{% block title %}Tableau de bord - Budgee Family{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="mb-4">
        <h2><i class="fas fa-chart-line"></i> Tableau de bord de <span class="text-success">{{ current_user.first_name }}</span></h2>
        <a href="{{ url_for('auth.profile') }}" class="text-decoration-none">
            <span class="badge bg-secondary" style="font-size: 0.75rem; cursor: pointer;">
                <i class="fas fa-crown"></i> Plan {{ current_user.plan.name }}
            </span>
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="{{ url_for('main.balance') }}" class="text-decoration-none">
                <div class="card stat-card text-white stat-card-clickable" style="background-color: #8b5cf6 !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1 opacity-75">Solde</h6>
                                <h2 class="mb-0">{{ solde | format_amount }} €</h2>
                            </div>
                            <div>
                                <i class="fas fa-calculator fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-3">
            <a href="{{ url_for('revenues.list') }}" class="text-decoration-none">
                <div class="card stat-card text-white stat-card-clickable" style="background-color: #10b981 !important;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1 opacity-75">Revenus actuels</h6>
                                <h2 class="mb-0">{{ total_revenues | format_amount }} €</h2>
                            </div>
                            <div>
                                <i class="fas fa-hand-holding-usd fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-3">
            <a href="{{ url_for('subscriptions.list', status='active') }}" class="text-decoration-none">
                <div class="card stat-card bg-primary text-white stat-card-clickable">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1 opacity-75">Abonnements actifs</h6>
                                <h2 class="mb-0">{{ total_subscriptions_cost | format_amount }} €</h2>
                            </div>
                            <div>
                                <i class="fas fa-list fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-3">
            <a href="{{ url_for('credits.list_credits') }}" class="text-decoration-none">
                <div class="card stat-card bg-warning text-white stat-card-clickable">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1 opacity-75">Crédits en cours</h6>
                                <h2 class="mb-0">{{ total_credits | format_amount }} €</h2>
                            </div>
                            <div>
                                <i class="fas fa-money-bill-wave fa-2x opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Colonne gauche : Revenus, Abonnements et Crédits -->
        <div class="col-lg-6">
            <!-- Revenus : Prochains versements -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hand-holding-usd"></i> Revenus : Prochains versements</h5>
                    <div class="d-flex align-items-center gap-2">
                        {% if upcoming_revenues %}
                            <span class="badge text-white" style="background-color: #10b981;">{{ upcoming_revenues|length }}</span>
                        {% endif %}
                        {% if current_user.is_premium() %}
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('exports.export_upcoming_revenues', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                    <i class="fas fa-file-excel"></i>
                                </a>
                                <a href="{{ url_for('exports.export_upcoming_revenues', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if upcoming_revenues %}
                        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            {% for revenue in upcoming_revenues %}
                                <div class="list-group-item subscription-item py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 100px;">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> {{ revenue.next_payment_date.strftime('%d/%m/%Y') }}
                                            </small>
                                        </div>
                                        <div class="flex-grow-1 text-start d-flex align-items-center" style="min-width: 0; gap: 0.5rem;">
                                            <strong class="text-truncate" style="max-width: 70%;" title="{{ revenue.name }}">{{ revenue.name }}</strong>
                                            {% if revenue.employer %}
                                                <span class="badge text-white" style="background-color: #10b981; padding: 0.15rem 0.4rem; font-size: 0.7rem;">{{ revenue.employer.name }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-shrink-0 text-end d-flex align-items-center justify-content-end" style="width: 200px;">
                                            <strong class="me-1">{{ revenue.amount | format_amount }} {{ revenue.currency | currency_symbol }}</strong>
                                            <span class="badge bg-secondary">{{ revenue.billing_cycle | translate_cycle }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="card-footer bg-white text-center">
                            <a href="{{ url_for('revenues.list') }}" class="btn btn-sm text-white" style="border: 1px solid #10b981; background-color: transparent; color: #10b981 !important;" onmouseover="this.style.backgroundColor='#10b981'; this.style.color='#fff !important';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#10b981 !important';">
                                <i class="fas fa-hand-holding-usd"></i> Voir tous les revenus
                            </a>
                            <a href="{{ url_for('revenues.add') }}" class="btn btn-sm text-white ms-2" style="border: 1px solid #10b981; background-color: transparent; color: #10b981 !important;" onmouseover="this.style.backgroundColor='#10b981'; this.style.color='#fff !important';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='#10b981 !important';">
                                <i class="fas fa-plus"></i> Ajouter
                            </a>
                        </div>
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted text-center py-4 mb-0">
                                <i class="fas fa-inbox fa-3x d-block mb-2"></i>
                                Aucun revenu actif
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Abonnements : Prochains renouvellements -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Abonnements : Prochains renouvellements</h5>
                    <div class="d-flex align-items-center gap-2">
                        {% if upcoming_renewals %}
                            <span class="badge bg-primary">{{ upcoming_renewals|length }}</span>
                        {% endif %}
                        {% if current_user.is_premium() %}
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('exports.export_upcoming_renewals', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                    <i class="fas fa-file-excel"></i>
                                </a>
                                <a href="{{ url_for('exports.export_upcoming_renewals', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if upcoming_renewals %}
                        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            {% for sub in upcoming_renewals %}
                                <div class="list-group-item subscription-item py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 100px;">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> {{ sub.get_display_date().strftime('%d/%m/%Y') }}
                                            </small>
                                        </div>
                                        <div class="flex-grow-1 text-start d-flex align-items-center" style="min-width: 0; gap: 0.5rem;">
                                            <strong class="text-truncate" style="max-width: 70%;" title="{{ sub.name }}">{{ sub.name }}</strong>{% if sub.plan %} <span class="badge bg-primary text-white" style="padding: 0.15rem 0.4rem; font-size: 0.7rem;">{{ sub.plan.name }}</span>{% endif %}
                                        </div>
                                        <div class="flex-shrink-0 text-end d-flex align-items-center justify-content-end" style="width: 200px;">
                                            <strong class="me-1">{{ sub.amount | format_amount }} {{ sub.currency | currency_symbol }}</strong>
                                            <span class="badge bg-secondary">{{ sub.billing_cycle | translate_cycle }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="card-footer bg-white text-center">
                            <a href="{{ url_for('subscriptions.list') }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-list"></i> Voir tous les abonnements
                            </a>
                            <a href="{{ url_for('subscriptions.add') }}" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fas fa-plus"></i> Ajouter
                            </a>
                        </div>
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted text-center py-4 mb-0">
                                <i class="fas fa-inbox fa-3x d-block mb-2"></i>
                                Aucun abonnement actif
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Crédits : Prochains prélèvements -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Crédits : Prochains prélèvements</h5>
                    <div class="d-flex align-items-center gap-2">
                        {% if upcoming_credits or upcoming_installments %}
                            <span class="badge bg-warning">{{ (upcoming_credits|length) + (upcoming_installments|length) }}</span>
                        {% endif %}
                        {% if current_user.is_premium() %}
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('exports.export_upcoming_credits', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                    <i class="fas fa-file-excel"></i>
                                </a>
                                <a href="{{ url_for('exports.export_upcoming_credits', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if upcoming_credits or upcoming_installments %}
                        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            {% for credit in upcoming_credits %}
                                <div class="list-group-item subscription-item py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 100px;">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> {{ credit.next_payment_date.strftime('%d/%m/%Y') }}
                                            </small>
                                        </div>
                                        <div class="flex-grow-1 text-start d-flex align-items-center" style="min-width: 0; gap: 0.5rem;">
                                            <strong class="text-truncate" style="max-width: 70%;" title="{{ credit.name }}">{{ credit.name }}</strong>
                                            {% if credit.remaining_amount %}
                                                <span class="badge bg-warning text-dark" style="padding: 0.15rem 0.4rem; font-size: 0.7rem;">Restant: {{ credit.remaining_amount | format_amount }} {{ credit.currency | currency_symbol }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-shrink-0 text-end d-flex align-items-center justify-content-end" style="width: 200px;">
                                            <strong class="me-1">{{ credit.amount | format_amount }} {{ credit.currency | currency_symbol }}</strong>
                                            <span class="badge bg-secondary">{{ credit.billing_cycle | translate_cycle }}</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                            {% for installment in upcoming_installments %}
                                <div class="list-group-item subscription-item py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 100px;">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> {{ installment.next_payment_date.strftime('%d/%m/%Y') }}
                                            </small>
                                        </div>
                                        <div class="flex-grow-1 text-start d-flex align-items-center" style="min-width: 0; gap: 0.5rem;">
                                            <strong class="text-truncate" style="max-width: 70%;" title="{{ installment.name }}">{{ installment.name }}</strong>
                                            <span class="badge bg-info text-white" style="padding: 0.15rem 0.4rem; font-size: 0.7rem;">{{ installment.installments_paid }}/{{ installment.number_of_installments }}</span>
                                            {% if installment.provider %}
                                                <span class="badge bg-secondary" style="padding: 0.15rem 0.4rem; font-size: 0.7rem;">{{ installment.provider }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex-shrink-0 text-end d-flex align-items-center justify-content-end" style="width: 200px;">
                                            <strong class="me-1">{{ installment.installment_amount | format_amount }} {{ installment.currency | currency_symbol }}</strong>
                                            <span class="badge bg-secondary">Mensuel</span>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="card-footer bg-white text-center">
                            <a href="{{ url_for('credits.list_credits') }}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-money-bill-wave"></i> Voir tous les crédits
                            </a>
                            <a href="{{ url_for('credits.add') }}" class="btn btn-sm btn-outline-warning ms-2">
                                <i class="fas fa-plus"></i> Ajouter
                            </a>
                            <a href="{{ url_for('installments.list') }}" class="btn btn-sm btn-outline-warning ms-2">
                                <i class="fas fa-calendar-alt"></i> Paiements en plusieurs fois
                            </a>
                        </div>
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted text-center py-4 mb-0">
                                <i class="fas fa-inbox fa-3x d-block mb-2"></i>
                                Aucun crédit actif
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Chèques : Non débités -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-money-check"></i> Chèques : Non débités</h5>
                    <div class="d-flex align-items-center gap-2">
                        {% if unpointed_checks %}
                            <span class="badge bg-danger">{{ unpointed_checks|length }}</span>
                        {% endif %}
                        {% if current_user.is_premium() %}
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('exports.export_unpointed_checks', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                    <i class="fas fa-file-excel"></i>
                                </a>
                                <a href="{{ url_for('exports.export_unpointed_checks', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if unpointed_checks %}
                        <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                            {% for check in unpointed_checks %}
                                <div class="list-group-item subscription-item py-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 30px;">
                                            <form method="post" action="{{ url_for('main.toggle_point', transaction_id=check.id) }}" style="display: inline; margin: 0;">
                                                <input type="hidden" name="redirect_to" value="dashboard">
                                                <button type="submit" class="btn btn-sm btn-link p-0" title="Pointer ce chèque" style="line-height: 1;">
                                                    <i class="far fa-circle text-muted" style="font-size: 1.2rem;"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="flex-shrink-0 d-flex align-items-center" style="width: 90px;">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar"></i> {{ check.transaction_date.strftime('%d/%m/%Y') }}
                                            </small>
                                        </div>
                                        <div class="flex-grow-1 text-start d-flex align-items-center" style="min-width: 0; gap: 0.5rem;">
                                            <strong class="text-truncate" style="max-width: 70%;" title="{{ check.name }}">{{ check.name }}</strong>
                                            <span class="badge bg-danger text-white" style="padding: 0.15rem 0.4rem; font-size: 0.7rem;">Chèque</span>
                                        </div>
                                        <div class="flex-shrink-0 text-end d-flex align-items-center justify-content-end" style="width: 150px;">
                                            <strong class="me-1">{{ check.amount | format_amount }} {{ check.currency | currency_symbol }}</strong>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="card-footer bg-white text-center">
                            <a href="{{ url_for('checkbooks.list_checkbooks') }}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-check"></i> Voir les chéquiers
                            </a>
                            <a href="{{ url_for('checkbooks.list_checkbooks') }}" class="btn btn-sm btn-outline-danger ms-2">
                                <i class="fas fa-plus"></i> Ajouter
                            </a>
                        </div>
                    {% else %}
                        <div class="card-body">
                            <p class="text-muted text-center py-4 mb-0">
                                <i class="fas fa-inbox fa-3x d-block mb-2"></i>
                                Tous les chèques sont débités
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Colonne droite : Répartition par catégorie -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Répartition des Abonnements & Crédits</h5>
                    {% if current_user.is_premium() %}
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('exports.export_category_distribution', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                <i class="fas fa-file-excel"></i>
                            </a>
                            <a href="{{ url_for('exports.export_category_distribution', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if category_stats %}
                        <canvas id="categoryChart" height="200"></canvas>
                    {% else %}
                        <p class="text-muted text-center py-4">Aucune donnée disponible</p>
                    {% endif %}
                </div>
            </div>

            <!-- Répartition des versements (Revenus) -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Répartition des versements</h5>
                    {% if current_user.is_premium() %}
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('exports.export_revenue_distribution', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                <i class="fas fa-file-excel"></i>
                            </a>
                            <a href="{{ url_for('exports.export_revenue_distribution', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if revenue_stats %}
                        <canvas id="revenueChart" height="200"></canvas>
                    {% else %}
                        <p class="text-muted text-center py-4">Aucune donnée disponible</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique des dépenses -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Évolution des revenus et des dépenses mensuelles</h5>
                    {% if current_user.is_premium() %}
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('exports.export_monthly_evolution', format='excel') }}" class="btn btn-outline-success" title="Exporter en Excel">
                                <i class="fas fa-file-excel"></i>
                            </a>
                            <a href="{{ url_for('exports.export_monthly_evolution', format='pdf') }}" class="btn btn-outline-danger" title="Exporter en PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <canvas id="spendingChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Fonction pour formater les montants au format français
function formatAmount(amount) {
    const formatted = amount.toFixed(2);
    const parts = formatted.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    return parts.join(',');
}
// Graphique par catégorie
{% if category_stats %}
const categoryCtx = document.getElementById('categoryChart').getContext('2d');

// Préparer les données avec la catégorie "Crédits"
let categoryLabels = {{ category_stats|map(attribute='name')|list|tojson }};
let categoryData = {{ category_stats|map(attribute='total')|list|tojson }};
let categoryColors = {{ category_stats|map(attribute='color')|list|tojson }};

// Ajouter la catégorie "Crédits" si elle a un montant
{% if total_credits and total_credits > 0 %}
categoryLabels.push('Crédits');
categoryData.push({{ total_credits }});
categoryColors.push('#ffc107'); // Jaune (Bootstrap warning)
{% endif %}

new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryData,
            backgroundColor: categoryColors
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += formatAmount(context.parsed) + ' €';
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}

// Graphique des revenus
{% if revenue_stats %}
const revenueCtx = document.getElementById('revenueChart').getContext('2d');

// Préparer les données des revenus
let revenueLabels = {{ revenue_stats|map(attribute='name')|list|tojson }};
let revenueData = {{ revenue_stats|map(attribute='total')|list|tojson }};
let revenueColors = {{ revenue_stats|map(attribute='color')|list|tojson }};

new Chart(revenueCtx, {
    type: 'doughnut',
    data: {
        labels: revenueLabels,
        datasets: [{
            data: revenueData,
            backgroundColor: revenueColors
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += formatAmount(context.parsed) + ' €';
                        return label;
                    }
                }
            }
        }
    }
});
{% endif %}

// Graphique des revenus et dépenses
fetch('/api/stats')
    .then(response => response.json())
    .then(data => {
        const spendingCtx = document.getElementById('spendingChart').getContext('2d');
        new Chart(spendingCtx, {
            type: 'line',
            data: {
                labels: data.monthly_spending.map(item => item.month),
                datasets: [
                    {
                        label: 'Abonnements (€)',
                        data: data.monthly_spending.map(item => item.total),
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Crédits (€)',
                        data: data.monthly_credits.map(item => item.total),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Revenus (€)',
                        data: data.monthly_revenues.map(item => item.total),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatAmount(context.parsed.y) + ' €';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatAmount(value) + ' €';
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}