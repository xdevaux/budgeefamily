{% extends "base.html" %}

{% block title %}Gestion des sauvegardes - Administration{% endblock %}

{% block content %}
<style>
    .month-separator {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin: 1.5rem 0 1rem 0;
        font-weight: 600;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-database"></i> Gestion des sauvegardes</h2>
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour au dashboard
            </a>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #e5e7eb;">
            <h5 class="mb-0"><i class="fas fa-tools text-secondary"></i> Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-2">
                    <form method="POST" action="{{ url_for('admin.backup_create') }}" onsubmit="return confirm('Créer une sauvegarde complète de la base de données et de l\'application ?');">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save"></i> Créer une nouvelle sauvegarde
                        </button>
                    </form>
                </div>
                <div class="col-md-6 mb-2">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="loadBackups()">
                        <i class="fas fa-sync"></i> Actualiser la liste
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des sauvegardes -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #e5e7eb;">
            <h5 class="mb-0"><i class="fas fa-list text-secondary"></i> Sauvegardes disponibles</h5>
        </div>
        <div class="card-body p-0">
            <div id="backups-list">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="text-muted mt-3">Chargement des sauvegardes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fonctions pour gérer les sauvegardes
function loadBackups() {
    const backupsList = document.getElementById('backups-list');
    backupsList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div><p class="text-muted mt-3">Chargement des sauvegardes...</p></div>';

    fetch('/admin/backup/list')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.grouped_backups && data.grouped_backups.length > 0) {
                let html = '';

                // Parcourir chaque groupe de mois
                data.grouped_backups.forEach((group, index) => {
                    // Ajouter le séparateur de mois
                    html += `<div class="month-separator ${index > 0 ? 'mt-3' : ''}">
                        <i class="fas fa-calendar-alt"></i> ${group.month_label}
                    </div>`;

                    // Tableau des sauvegardes pour ce mois
                    html += '<div class="table-responsive mb-3"><table class="table table-hover mb-0"><thead class="table-light"><tr><th><i class="fas fa-file-archive"></i> Nom du fichier</th><th><i class="fas fa-calendar"></i> Date de création</th><th><i class="fas fa-hdd"></i> Taille</th><th><i class="fas fa-tag"></i> Type</th><th class="text-end"><i class="fas fa-cog"></i> Actions</th></tr></thead><tbody>';

                    group.backups.forEach(backup => {
                        // Déterminer le badge de type
                        let typeBadge = '';
                        if (backup.type === 'manual') {
                            typeBadge = '<span class="badge bg-primary">Manuel</span>';
                        } else if (backup.type === 'auto') {
                            typeBadge = '<span class="badge bg-success">Automatique</span>';
                        } else {
                            typeBadge = '<span class="badge bg-secondary">Inconnu</span>';
                        }

                        html += `<tr>
                            <td><i class="fas fa-file-archive text-primary me-2"></i><strong>${backup.filename}</strong></td>
                            <td><small class="text-muted">${backup.modified_formatted}</small></td>
                            <td><span class="badge bg-info">${backup.size_mb} Mo</span></td>
                            <td>${typeBadge}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <a href="/admin/backup/download/${backup.filename}" class="btn btn-outline-success" title="Télécharger">
                                        <i class="fas fa-download"></i> Télécharger
                                    </a>
                                    <button onclick="deleteBackup('${backup.filename}')" class="btn btn-outline-danger" title="Supprimer">
                                        <i class="fas fa-trash"></i> Supprimer
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                });

                backupsList.innerHTML = html;
            } else {
                backupsList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Aucune sauvegarde disponible</h5>
                        <p class="text-muted">Créez votre première sauvegarde pour commencer</p>
                    </div>`;
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des sauvegardes:', error);
            backupsList.innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erreur lors du chargement des sauvegardes</strong>
                    <p class="mb-0 mt-2">Détails: ${error.message}</p>
                </div>`;
        });
}

function deleteBackup(filename) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer la sauvegarde "${filename}" ?\n\nCette action est irréversible.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/backup/delete/${filename}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Charger les sauvegardes au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadBackups();
});
</script>
{% endblock %}
