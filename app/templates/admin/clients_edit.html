{% extends "base.html" %}

{% block title %}Modifier un client - Administration{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-user-edit text-secondary"></i> Modifier le client</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.clients_edit', user_id=user.id) }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">Prénom</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" value="{{ user.first_name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Nom</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" value="{{ user.last_name }}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ user.email }}" required>
                        </div>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">Nouveau mot de passe</label>
                            <input type="password" class="form-control" id="new_password" name="new_password">
                            <small class="form-text text-muted">Laisser vide pour ne pas changer le mot de passe</small>
                        </div>

                        <div class="mb-3">
                            <label for="country" class="form-label">Pays <span class="text-danger">*</span></label>
                            <select class="form-select" id="country" name="country" required>
                                <option value="">Sélectionnez un pays</option>
                                <option value="FR" {% if user.country == 'FR' %}selected{% endif %}>France</option>
                                <option value="ES" {% if user.country == 'ES' %}selected{% endif %}>Espagne</option>
                                <option value="IT" {% if user.country == 'IT' %}selected{% endif %}>Italie</option>
                                <option value="DE" {% if user.country == 'DE' %}selected{% endif %}>Allemagne</option>
                                <option value="GB" {% if user.country == 'GB' %}selected{% endif %}>Royaume-Uni</option>
                                <option value="PT" {% if user.country == 'PT' %}selected{% endif %}>Portugal</option>
                                <option value="BE" {% if user.country == 'BE' %}selected{% endif %}>Belgique</option>
                                <option value="NL" {% if user.country == 'NL' %}selected{% endif %}>Pays-Bas</option>
                                <option value="CH" {% if user.country == 'CH' %}selected{% endif %}>Suisse</option>
                                <option value="AT" {% if user.country == 'AT' %}selected{% endif %}>Autriche</option>
                                <option value="SE" {% if user.country == 'SE' %}selected{% endif %}>Suède</option>
                                <option value="NO" {% if user.country == 'NO' %}selected{% endif %}>Norvège</option>
                                <option value="DK" {% if user.country == 'DK' %}selected{% endif %}>Danemark</option>
                                <option value="FI" {% if user.country == 'FI' %}selected{% endif %}>Finlande</option>
                                <option value="US" {% if user.country == 'US' %}selected{% endif %}>États-Unis</option>
                                <option value="CA" {% if user.country == 'CA' %}selected{% endif %}>Canada</option>
                                <option value="BR" {% if user.country == 'BR' %}selected{% endif %}>Brésil</option>
                                <option value="AR" {% if user.country == 'AR' %}selected{% endif %}>Argentine</option>
                                <option value="MX" {% if user.country == 'MX' %}selected{% endif %}>Mexique</option>
                                <option value="CN" {% if user.country == 'CN' %}selected{% endif %}>Chine</option>
                                <option value="JP" {% if user.country == 'JP' %}selected{% endif %}>Japon</option>
                                <option value="AU" {% if user.country == 'AU' %}selected{% endif %}>Australie</option>
                                <option value="MA" {% if user.country == 'MA' %}selected{% endif %}>Maroc</option>
                                <option value="TN" {% if user.country == 'TN' %}selected{% endif %}>Tunisie</option>
                                <option value="DZ" {% if user.country == 'DZ' %}selected{% endif %}>Algérie</option>
                                <option value="SN" {% if user.country == 'SN' %}selected{% endif %}>Sénégal</option>
                                <option value="CI" {% if user.country == 'CI' %}selected{% endif %}>Côte d'Ivoire</option>
                                <option value="GP" {% if user.country == 'GP' %}selected{% endif %}>Guadeloupe</option>
                                <option value="MQ" {% if user.country == 'MQ' %}selected{% endif %}>Martinique</option>
                                <option value="GF" {% if user.country == 'GF' %}selected{% endif %}>Guyane</option>
                                <option value="RE" {% if user.country == 'RE' %}selected{% endif %}>Réunion</option>
                                <option value="NC" {% if user.country == 'NC' %}selected{% endif %}>Nouvelle-Calédonie</option>
                            </select>
                            <small class="form-text text-muted">Fuseau horaire actuel: <strong>{{ user.timezone or 'Non défini' }}</strong></small>
                        </div>

                        <div class="mb-3">
                            <label for="plan_id" class="form-label">Plan</label>
                            <select class="form-select" id="plan_id" name="plan_id">
                                <option value="">Aucun plan</option>
                                {% for plan in plans %}
                                <option value="{{ plan.id }}" {% if user.plan and user.plan.id == plan.id %}selected{% endif %}>
                                    {{ plan.name }} - {{ plan.price }}€/{{ plan.billing_period }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="storage_limit_gb" class="form-label">Limite de stockage (Go)</label>
                            <input type="number" class="form-control" id="storage_limit_gb" name="storage_limit_gb"
                                   value="{{ user.get_storage_limit_gb() }}"
                                   min="1" max="1000" step="0.1" required>
                            <small class="form-text text-muted">
                                Espace actuellement utilisé : <strong>{{ user.get_storage_used_gb() }} Go</strong> ({{ user.get_storage_percentage() }}%)
                                <br>Par défaut : 5 Go (Gratuit), 20 Go (Premium)
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Options du compte</label>
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" id="is_admin" name="is_admin" {% if user.is_admin %}checked{% endif %}>
                                <label class="form-check-label" for="is_admin">
                                    <i class="fas fa-crown text-warning"></i> <strong>Administrateur</strong>
                                    <small class="text-muted d-block">Accès complet à l'administration</small>
                                </label>
                            </div>
                            <div class="form-check">
                                {% if user.id == current_user.id %}
                                    {# Si c'est son propre compte, forcer la valeur à "on" avec un champ caché #}
                                    <input type="hidden" name="is_active" value="on">
                                    <input type="checkbox" class="form-check-input" id="is_active" checked disabled>
                                {% else %}
                                    <input type="checkbox" class="form-check-input" id="is_active" name="is_active"
                                           {% if user.is_active %}checked{% endif %}>
                                {% endif %}
                                <label class="form-check-label" for="is_active">
                                    <i class="fas fa-toggle-on text-success"></i> <strong>Compte actif</strong>
                                    <small class="text-muted d-block">
                                        {% if user.id == current_user.id %}
                                            Vous ne pouvez pas désactiver votre propre compte
                                        {% else %}
                                            L'utilisateur peut se connecter et utiliser l'application
                                        {% endif %}
                                    </small>
                                </label>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <small>
                                <strong>Informations :</strong><br>
                                - ID: {{ user.id }}<br>
                                - Créé le: {{ user.created_at | format_datetime('%d/%m/%Y à %H:%M') }}<br>
                                - Dernière modification: {{ user.updated_at | format_datetime('%d/%m/%Y à %H:%M') }}<br>
                                - Email vérifié: {% if user.email_verified %}<span class="text-success">Oui</span> ({{ user.email_verified_at | format_datetime('%d/%m/%Y') }}){% else %}<span class="text-danger">Non</span>{% endif %}<br>
                                - Pays: {{ user.country or 'Non défini' }}<br>
                                - Fuseau horaire: {{ user.timezone or 'Non défini' }}<br>
                                - Abonnements actifs: {{ user.get_active_subscriptions_count() }}
                            </small>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.clients_list') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Retour
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Enregistrer les modifications
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
