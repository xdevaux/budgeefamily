{% extends "base.html" %}

{% block title %}Plans et tarifs - Budgee Family{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Choisissez votre plan</h1>
        <p class="lead text-muted">Simple, transparent et adapté à vos besoins</p>
    </div>

    <div class="row justify-content-center g-4">
        <!-- Plan Gratuit -->
        <div class="col-lg-4">
            <div class="card h-100 shadow">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold">Gratuit</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">0€</span>
                            <span class="text-muted">/mois</span>
                        </div>
                        <p class="text-muted">Parfait pour commencer</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 gestion d'Abonnements</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>1 gestion des Crédits</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>1 gestion des Revenus</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Accès aux services par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Accès aux formules par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 catégories personnalisées</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 services personnalisés</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>10 formules personnalisées</strong>
                        </li>
                         <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Stockage des documents <strong>5go</strong> upgradable
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Statistiques détaillées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Notifications dans l'application
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Support communautaire
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Free' %}
                            <button class="btn btn-outline-secondary w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{{ url_for('auth.register') }}" class="btn btn-outline-primary w-100">
                            Commencer gratuitement
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Premium Mensuel -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-lg border-primary position-relative">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge bg-primary px-3 py-2">Populaire</span>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-primary">Premium</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">7,99€</span>
                            <span class="text-muted">/mois</span>
                        </div>
                        <p class="text-muted">Facturation mensuelle</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Abonnements illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Crédits illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Revenus illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux services par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Catégories personnalisées illimitées</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Logos, couleurs, icônes
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Services personnalisés illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Formules personnalisés illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Stockage des documents <strong>20go</strong> upgradable
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Statistiques avancées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Notifications dans l'application et par mail
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Support prioritaire
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Export des données (PDF, CSV)
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Premium' %}
                            <button class="btn btn-primary w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% else %}
                            <button class="btn btn-primary w-100" id="checkoutButtonMonthly">
                                <i class="fas fa-crown"></i> Passer à Premium
                            </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-primary w-100" onclick="showSignupModal('monthly', 'Premium')">
                            <i class="fas fa-crown"></i> Commencer avec Premium
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Premium Annuel -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-lg border-warning position-relative">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge bg-warning text-dark px-3 py-2">Meilleure offre</span>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-warning">Premium Annuel</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">79,99€</span>
                            <span class="text-muted">/an</span>
                        </div>
                        <p class="text-success mb-0">
                            <i class="fas fa-gift"></i> <strong>Soit 2 mois gratuits</strong>
                        </p>
                        <p class="text-muted small">(Économie de 15€)</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Abonnements illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Crédits illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Gestion des Revenus illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux services par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Catégories personnalisées illimitées</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Logos, couleurs, icônes
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Services personnalisés illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Formules personnalisés illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Stockage des documents <strong>20go</strong> upgradable
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Statistiques avancées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Notifications dans l'application et par mail
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Support prioritaire
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Export des données (PDF, CSV)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-star text-warning me-2"></i>
                            <strong>2 mois gratuits</strong>
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Premium Annual' %}
                            <button class="btn btn-warning w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% else %}
                            <button class="btn btn-warning w-100" id="checkoutButtonYearly">
                                <i class="fas fa-crown"></i> Passer à Premium Annuel
                            </button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-warning w-100" onclick="showSignupModal('yearly', 'Premium Annuel')">
                            <i class="fas fa-crown"></i> Commencer avec Premium Annuel
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Comparatif des économies -->
    <div class="row mt-5">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-light border-0">
                <div class="card-body p-4 text-center">
                    <h5 class="mb-3"><i class="fas fa-calculator"></i> Comparatif des prix</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Premium Mensuel</strong>
                            </div>
                            <div class="text-muted">7,99€ x 12 mois = <strong>95,88€/an</strong></div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Premium Annuel</strong>
                            </div>
                            <div class="text-success"><strong>79,99€/an</strong></div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Votre économie</strong>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-arrow-down"></i> <strong>-15,89€</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ -->
    <div class="row mt-5">
        <div class="col-lg-10 mx-auto">
            <h3 class="text-center mb-4">Questions fréquentes</h3>
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            Puis-je changer de plan à tout moment ?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Oui, vous pouvez passer du plan gratuit au plan Premium (mensuel ou annuel) à tout moment. Le changement est immédiat.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            Quelle est la différence entre Premium Mensuel et Annuel ?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Les deux plans offrent exactement les mêmes fonctionnalités. Le plan annuel vous permet d'économiser 10€ par an (équivalent à 2 mois gratuits) en payant pour toute l'année d'avance.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            Comment se passe l'annulation ?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Vous pouvez annuler votre abonnement Premium à tout moment depuis votre profil. Aucun engagement, aucuns frais cachés. Pour le plan annuel, aucun remboursement au prorata n'est effectué.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                            Mes données sont-elles sécurisées ?
                        </button>
                    </h2>
                    <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Absolument. Vos données sont chiffrées et sauvegardées régulièrement. Nous n'avons accès à aucune de vos informations bancaires, tout est géré par Stripe.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale d'inscription pour les non-connectés -->
<div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title" id="signupModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    Créer mon compte Premium
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div id="signup-plan-info" class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    Vous vous apprêtez à souscrire au plan <strong id="selected-plan-name"></strong>
                </div>

                <form id="signupForm">
                    <div class="mb-3">
                        <label for="signup_first_name" class="form-label">Prénom</label>
                        <input type="text" class="form-control" id="signup_first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="signup_last_name" class="form-label">Nom</label>
                        <input type="text" class="form-control" id="signup_last_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="signup_email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="signup_email" required>
                    </div>
                    <div class="mb-3">
                        <label for="signup_date_of_birth" class="form-label">Date de naissance</label>
                        <input type="date" class="form-control" id="signup_date_of_birth">
                    </div>
                    <div class="mb-3">
                        <label for="signup_password" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="signup_password" minlength="6" required>
                        <div class="form-text">Minimum 6 caractères</div>
                    </div>
                    <div class="mb-3">
                        <label for="signup_country" class="form-label">Pays</label>
                        <select class="form-select" id="signup_country" required>
                            <option value="">Sélectionnez votre pays</option>
                            <option value="FR">France</option>
                            <option value="BE">Belgique</option>
                            <option value="CH">Suisse</option>
                            <option value="CA">Canada</option>
                            <option value="LU">Luxembourg</option>
                            <option value="MC">Monaco</option>
                            <option value="US">États-Unis</option>
                            <option value="GB">Royaume-Uni</option>
                            <option value="DE">Allemagne</option>
                            <option value="ES">Espagne</option>
                            <option value="IT">Italie</option>
                        </select>
                    </div>

                    <div id="signup-error" class="alert alert-danger d-none mb-3"></div>

                    <button type="submit" class="btn btn-primary w-100" id="signupButton">
                        <i class="fas fa-check-circle me-2"></i>
                        Créer mon compte et payer
                    </button>
                </form>

                <div class="text-center mt-3">
                    <small class="text-muted">
                        Déjà inscrit ? <a href="{{ url_for('auth.login') }}">Connectez-vous</a>
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <small class="text-muted">
                    <i class="fas fa-shield-alt text-success me-1"></i>
                    Vos données sont sécurisées et protégées
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modale de paiement intégré -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="checkoutModalLabel">
                    <i class="fas fa-lock text-success me-2"></i>
                    Paiement sécurisé
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="checkout-container">
                    <!-- Le formulaire Stripe sera injecté ici -->
                </div>
                <div id="checkout-spinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3 text-muted">Chargement du formulaire de paiement...</p>
                </div>
                <div id="checkout-error" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-message"></span>
                </div>
            </div>
            <div class="modal-footer border-0 bg-light">
                <div class="text-muted small">
                    <i class="fas fa-shield-alt text-success me-2"></i>
                    Paiement sécurisé par <strong>Stripe</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charger Stripe.js pour tous les utilisateurs -->
<script src="https://js.stripe.com/v3/"></script>

<script>
// Fonction pour afficher la modale d'inscription
let selectedPlanType = '';
let selectedPlanName = '';

function showSignupModal(planType, planName) {
    selectedPlanType = planType;
    selectedPlanName = planName;

    document.getElementById('selected-plan-name').textContent = planName;
    document.getElementById('signup-error').classList.add('d-none');
    document.getElementById('signupForm').reset();

    const modal = new bootstrap.Modal(document.getElementById('signupModal'));
    modal.show();
}

// Gérer la soumission du formulaire d'inscription
document.getElementById('signupForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitButton = document.getElementById('signupButton');
    const errorDiv = document.getElementById('signup-error');
    const originalButtonText = submitButton.innerHTML;

    // Désactiver le bouton et afficher un spinner
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Création du compte...';
    errorDiv.classList.add('d-none');

    try {
        const response = await fetch('/auth/api/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: document.getElementById('signup_email').value,
                password: document.getElementById('signup_password').value,
                first_name: document.getElementById('signup_first_name').value,
                last_name: document.getElementById('signup_last_name').value,
                date_of_birth: document.getElementById('signup_date_of_birth').value,
                country: document.getElementById('signup_country').value,
                plan_type: selectedPlanType
            })
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Erreur lors de l\'inscription');
        }

        // Inscription réussie, fermer la modale et ouvrir le paiement
        bootstrap.Modal.getInstance(document.getElementById('signupModal')).hide();

        // Attendre que la modale se ferme complètement avant d'ouvrir le paiement
        setTimeout(() => {
            initCheckout(selectedPlanType, selectedPlanName);
        }, 500);

    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
        submitButton.disabled = false;
        submitButton.innerHTML = originalButtonText;
    }
});

// Initialiser Stripe avec la clé publique (pour tous les utilisateurs)
{% if config.STRIPE_PUBLIC_KEY %}
const stripe = Stripe('{{ config.STRIPE_PUBLIC_KEY }}');
{% else %}
console.error('STRIPE_PUBLIC_KEY non configurée');
const stripe = null;
{% endif %}

let checkoutInstance = null;

// Fonction pour afficher une erreur
function showError(message) {
    document.getElementById('checkout-spinner').classList.add('d-none');
    document.getElementById('checkout-container').classList.add('d-none');
    document.getElementById('checkout-error').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

// Fonction pour initialiser le checkout
async function initCheckout(planType, planName) {
    const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
    const modalTitle = document.getElementById('checkoutModalLabel');

    // Mettre à jour le titre
    modalTitle.innerHTML = `<i class="fas fa-lock text-success me-2"></i>Souscription à ${planName}`;

    // Réinitialiser l'affichage
    document.getElementById('checkout-spinner').classList.remove('d-none');
    document.getElementById('checkout-container').classList.add('d-none');
    document.getElementById('checkout-error').classList.add('d-none');

    // Afficher la modale
    modal.show();

    // Vérifier que Stripe est configuré
    if (!stripe) {
        showError('Stripe n\'est pas configuré. Veuillez contacter le support.');
        return;
    }

    try {
        // Créer une session de paiement
        const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                plan: planType,
                embedded: true  // Mode intégré
            })
        });

        const data = await response.json();

        if (data.error) {
            showError(data.error);
            return;
        }

        if (!data.client_secret) {
            showError('Erreur lors de la création de la session de paiement');
            return;
        }

        // Initialiser le Checkout Stripe embedded
        checkoutInstance = await stripe.initEmbeddedCheckout({
            clientSecret: data.client_secret
        });

        // Masquer le spinner et afficher le formulaire
        document.getElementById('checkout-spinner').classList.add('d-none');
        document.getElementById('checkout-container').classList.remove('d-none');

        // Monter le checkout dans le conteneur
        checkoutInstance.mount('#checkout-container');

    } catch (error) {
        console.error('Erreur:', error);
        showError('Une erreur est survenue lors du chargement du formulaire de paiement');
    }
}

// Nettoyer le checkout quand la modale se ferme
document.getElementById('checkoutModal').addEventListener('hidden.bs.modal', function () {
    if (checkoutInstance) {
        checkoutInstance.destroy();
        checkoutInstance = null;
    }
    document.getElementById('checkout-container').innerHTML = '';
});

{% if current_user.is_authenticated and current_user.plan and current_user.plan.name not in ['Premium', 'Premium Annual'] %}
// Boutons pour les utilisateurs connectés (upgrade)
const monthlyBtn = document.getElementById('checkoutButtonMonthly');
const yearlyBtn = document.getElementById('checkoutButtonYearly');

if (monthlyBtn) {
    monthlyBtn.addEventListener('click', function() {
        initCheckout('monthly', 'Premium Mensuel');
    });
}

if (yearlyBtn) {
    yearlyBtn.addEventListener('click', function() {
        initCheckout('yearly', 'Premium Annuel');
    });
}
{% endif %}
</script>
{% endblock %}
