{% extends "base.html" %}

{% block title %}Plans et tarifs - Subly Cloud{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Choisissez votre plan</h1>
        <p class="lead text-muted">Simple, transparent et adapté à vos besoins</p>
    </div>

    <div class="row justify-content-center g-4">
        <!-- Plan Gratuit -->
        <div class="col-lg-4">
            <div class="card h-100 shadow">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold">Free</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">0€</span>
                            <span class="text-muted">/mois</span>
                        </div>
                        <p class="text-muted">Parfait pour commencer</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 abonnements</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 catégories personnalisées</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>5 services personnalisés</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Jusqu'à <strong>10 formules personnalisées</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Accès aux services globaux
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Statistiques détaillées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Notifications de renouvellement
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-success me-2"></i>
                            Support communautaire
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Free' %}
                            <button class="btn btn-outline-secondary w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{{ url_for('auth.register') }}" class="btn btn-outline-primary w-100">
                            Commencer gratuitement
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Premium Mensuel -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-lg border-primary position-relative">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge bg-primary px-3 py-2">Populaire</span>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-primary">Premium</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">4.99€</span>
                            <span class="text-muted">/mois</span>
                        </div>
                        <p class="text-muted">Facturation mensuelle</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Abonnements illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Catégories personnalisées illimitées</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Logos, couleurs, icônes
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            <strong>Services personnalisés illimités</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Avec formules illimitées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Accès aux services globaux
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Statistiques avancées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Notifications personnalisables
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Support prioritaire
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-primary me-2"></i>
                            Export des données (PDF, CSV)
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Premium' %}
                            <button class="btn btn-primary w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% else %}
                            <button class="btn btn-primary w-100" id="checkoutButtonMonthly">
                                <i class="fas fa-crown"></i> Passer à Premium
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{{ url_for('auth.register', plan='premium') }}" class="btn btn-primary w-100">
                            Commencer avec Premium
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Plan Premium Annuel -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-lg border-warning position-relative">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge bg-warning text-dark px-3 py-2">Meilleure offre</span>
                </div>
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-warning">Premium Annuel</h3>
                        <div class="my-4">
                            <span class="display-4 fw-bold">49.99€</span>
                            <span class="text-muted">/an</span>
                        </div>
                        <p class="text-success mb-0">
                            <i class="fas fa-gift"></i> <strong>Soit 2 mois gratuits</strong>
                        </p>
                        <p class="text-muted small">(Économie de 10€)</p>
                    </div>

                    <ul class="list-unstyled mb-4">
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            <strong>Abonnements illimités</strong>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            <strong>Catégories personnalisées illimitées</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Logos, couleurs, icônes
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            <strong>Services personnalisés illimités</strong>
                        </li>
                        <li class="mb-3 small text-muted ps-4">
                            Avec formules illimitées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Accès aux catégories par défaut
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Accès aux services globaux
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Statistiques avancées
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Notifications personnalisables
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Support prioritaire
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-check text-warning me-2"></i>
                            Export des données (PDF, CSV)
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-star text-warning me-2"></i>
                            <strong>2 mois gratuits</strong>
                        </li>
                    </ul>

                    {% if current_user.is_authenticated %}
                        {% if current_user.plan and current_user.plan.name == 'Premium Annual' %}
                            <button class="btn btn-warning w-100" disabled>
                                <i class="fas fa-check"></i> Plan actuel
                            </button>
                        {% else %}
                            <button class="btn btn-warning w-100" id="checkoutButtonYearly">
                                <i class="fas fa-crown"></i> Passer à Premium Annuel
                            </button>
                        {% endif %}
                    {% else %}
                        <a href="{{ url_for('auth.register', plan='premium-annual') }}" class="btn btn-warning w-100">
                            Commencer avec Premium Annuel
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Comparatif des économies -->
    <div class="row mt-5">
        <div class="col-lg-8 mx-auto">
            <div class="card bg-light border-0">
                <div class="card-body p-4 text-center">
                    <h5 class="mb-3"><i class="fas fa-calculator"></i> Comparatif des prix</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Premium Mensuel</strong>
                            </div>
                            <div class="text-muted">4.99€ x 12 mois = <strong>59.88€/an</strong></div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Premium Annuel</strong>
                            </div>
                            <div class="text-success"><strong>49.99€/an</strong></div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Votre économie</strong>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-arrow-down"></i> <strong>-9.89€</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ -->
    <div class="row mt-5">
        <div class="col-lg-10 mx-auto">
            <h3 class="text-center mb-4">Questions fréquentes</h3>
            <div class="accordion" id="faqAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            Puis-je changer de plan à tout moment ?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Oui, vous pouvez passer du plan gratuit au plan Premium (mensuel ou annuel) à tout moment. Le changement est immédiat.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            Quelle est la différence entre Premium Mensuel et Annuel ?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Les deux plans offrent exactement les mêmes fonctionnalités. Le plan annuel vous permet d'économiser 10€ par an (équivalent à 2 mois gratuits) en payant pour toute l'année d'avance.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            Comment se passe l'annulation ?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Vous pouvez annuler votre abonnement Premium à tout moment depuis votre profil. Aucun engagement, aucuns frais cachés. Pour le plan annuel, aucun remboursement au prorata n'est effectué.
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                            Mes données sont-elles sécurisées ?
                        </button>
                    </h2>
                    <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Absolument. Vos données sont chiffrées et sauvegardées régulièrement. Nous n'avons accès à aucune de vos informations bancaires, tout est géré par Stripe.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if current_user.is_authenticated and current_user.plan and current_user.plan.name not in ['Premium', 'Premium Annual'] %}
<script>
// Bouton Premium Mensuel
document.getElementById('checkoutButtonMonthly').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';

    try {
        const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ plan: 'monthly' })
        });
        const data = await response.json();

        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('Erreur lors de la création de la session de paiement');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-crown"></i> Passer à Premium';
        }
    } catch (error) {
        alert('Erreur lors de la création de la session de paiement');
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-crown"></i> Passer à Premium';
    }
});

// Bouton Premium Annuel
document.getElementById('checkoutButtonYearly').addEventListener('click', async function() {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';

    try {
        const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ plan: 'yearly' })
        });
        const data = await response.json();

        if (data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            alert('Erreur lors de la création de la session de paiement');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-crown"></i> Passer à Premium Annuel';
        }
    } catch (error) {
        alert('Erreur lors de la création de la session de paiement');
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-crown"></i> Passer à Premium Annuel';
    }
});
</script>
{% endif %}
{% endblock %}
