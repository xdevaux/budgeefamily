{% extends "base.html" %}

{% block title %}{{ reminder.name }} - Budgee Family{% endblock %}

{% block extra_css %}
<style>
    .document-card {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }
    .document-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .document-card.invoice { border-left-color: #10b981; }
    .document-card.contract { border-left-color: #6366f1; }
    .document-card.report { border-left-color: #f59e0b; }
    .document-card.certificate { border-left-color: #8b5cf6; }
    .document-card.other { border-left-color: #6c757d; }

    .doc-stats-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .doc-stats-card:hover {
        transform: scale(1.02);
    }
    .doc-stats-card.active {
        border: 2px solid #6366f1;
    }

    .year-separator {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        margin: 1.5rem 0 1rem 0;
        font-weight: 600;
    }

    .doc-type-badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }

    /* Styles for preview modal */
    .document-preview-modal .modal-dialog {
        max-width: 80%;
        max-height: 90vh;
        margin: 2rem auto;
    }
    .document-preview-modal .modal-content {
        height: 85vh;
        border-radius: 12px;
        overflow: hidden;
    }
    .document-preview-modal .modal-header {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
    }
    .document-preview-modal .modal-header .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    .document-preview-modal .modal-header .btn-close:hover {
        opacity: 1;
    }
    .document-preview-modal .modal-body {
        padding: 0;
        height: calc(100% - 56px);
        overflow: hidden;
        background: #f8f9fa;
    }
    .document-preview-modal .modal-body iframe,
    .document-preview-modal .modal-body embed {
        width: 100%;
        height: 100%;
        border: none;
    }
    .document-preview-modal .modal-body img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
        margin: auto;
    }
    .preview-image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 1rem;
        background: #2d2d2d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-bell"></i> {{ reminder.name }}</h2>
        <div class="btn-group">
            <a href="{{ url_for('reminders.edit', reminder_id=reminder.id) }}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{{ url_for('reminders.list') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Main information -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Reminder date</h6>
                    <h2 class="mb-0">{{ '%02d'|format(reminder.reminder_month) }}/{{ reminder.reminder_year }}</h2>
                    <small class="text-muted">
                        {% if reminder.recurrence == 'annual' %}Annual{% elif reminder.recurrence == 'semiannual' %}Semiannual{% elif reminder.recurrence == 'biennial' %}Biennial{% else %}Once{% endif %}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Estimated cost</h6>
                    <h2 class="mb-0">
                        {% if reminder.estimated_cost %}
                            {{ reminder.estimated_cost | format_amount }} {{ reminder.currency | currency_symbol }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </h2>
                    <small class="text-muted">Projected budget</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center {% if reminder.appointment_booked %}border-success{% else %}border-warning{% endif %}">
                <div class="card-body">
                    <h6 class="text-muted">Appointment</h6>
                    {% if reminder.appointment_booked %}
                        <h2 class="mb-0 text-success"><i class="fas fa-check-circle"></i></h2>
                        <small class="text-success">
                            Appointment booked
                            {% if reminder.appointment_date %}
                                <br>{{ reminder.appointment_date.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </small>
                    {% else %}
                        <h2 class="mb-0 text-warning"><i class="fas fa-clock"></i></h2>
                        <small class="text-warning">To schedule</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Information column -->
        <div class="col-lg-4">
            <!-- Reminder details -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-info-circle text-secondary"></i> Details</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Provider:</strong><br>
                        {% if reminder.provider %}
                            <i class="fas fa-user-tie text-primary"></i> {{ reminder.provider.name }}
                            {% if reminder.provider.contact_info %}
                                <br><small class="text-muted">{{ reminder.provider.contact_info }}</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Not defined</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>Status:</strong><br>
                        {% if reminder.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Archived</span>
                        {% endif %}
                    </div>

                    {% if reminder.description %}
                    <div class="mb-0">
                        <strong>Description:</strong><br>
                        <p class="mb-0">{{ reminder.description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Appointment management -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-calendar-check text-secondary"></i> Appointment</h5>
                </div>
                <div class="card-body">
                    {% if reminder.appointment_booked %}
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-check-circle"></i> Appointment booked
                            {% if reminder.appointment_date %}
                                <br>On <strong>{{ reminder.appointment_date.strftime('%d/%m/%Y') }}</strong>
                            {% endif %}
                        </div>
                        <form method="POST" action="{{ url_for('reminders.toggle_appointment', reminder_id=reminder.id) }}">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="fas fa-times"></i> Cancel appointment
                            </button>
                        </form>
                    {% else %}
                        <form method="POST" action="{{ url_for('reminders.toggle_appointment', reminder_id=reminder.id) }}">
                            <div class="mb-3">
                                <label for="appointment_date" class="form-label">Appointment date:</label>
                                <input type="date" class="form-control" id="appointment_date" name="appointment_date" required>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-check"></i> Mark appointment as booked
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- Document statistics -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <i class="fas fa-chart-pie text-secondary"></i> Documents
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        {% for code, name, icon, color in document_types %}
                            <div class="col-6">
                                <a href="{{ url_for('reminders.detail', reminder_id=reminder.id, doc_type=code) }}"
                                   class="card doc-stats-card text-decoration-none {% if filter_type == code %}active{% endif %}"
                                   style="border-left: 4px solid {{ color }};">
                                    <div class="card-body p-2 text-center">
                                        <i class="fas {{ icon }}" style="color: {{ color }};"></i>
                                        <div class="fw-bold">{{ doc_counts.get(code, 0) }}</div>
                                        <small class="text-muted">{{ name }}</small>
                                    </div>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-cog text-secondary"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if reminder.is_active %}
                            <form method="POST" action="{{ url_for('reminders.archive', reminder_id=reminder.id) }}"
                                  onsubmit="return confirm('Archive this reminder? A new reminder will be automatically created if recurring.')">
                                <button type="submit" class="btn btn-info w-100">
                                    <i class="fas fa-archive"></i> Archive
                                </button>
                            </form>
                        {% else %}
                            <form method="POST" action="{{ url_for('reminders.unarchive', reminder_id=reminder.id) }}"
                                  onsubmit="return confirm('Unarchive this reminder?')">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-box-open"></i> Unarchive
                                </button>
                            </form>
                        {% endif %}
                        <form method="POST" action="{{ url_for('reminders.delete', reminder_id=reminder.id) }}"
                              onsubmit="return confirm('Are you sure you want to delete this reminder?')">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents column -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #e5e7eb;">
                    <span>
                        <i class="fas fa-folder-open text-secondary"></i> Documents
                        {% if total_size > 0 %}
                            <span class="badge bg-info ms-2">
                                <i class="fas fa-hdd"></i>
                                {% if total_size >= 1073741824 %}
                                    {{ "%.2f"|format(total_size / 1073741824) }} GB
                                {% elif total_size >= 1048576 %}
                                    {{ "%.2f"|format(total_size / 1048576) }} MB
                                {% elif total_size >= 1024 %}
                                    {{ "%.2f"|format(total_size / 1024) }} KB
                                {% else %}
                                    {{ total_size }} bytes
                                {% endif %}
                            </span>
                        {% endif %}
                    </span>
                    <a href="{{ url_for('reminders.add_document', reminder_id=reminder.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Add document
                    </a>
                </div>
                <div class="card-body">
                    <!-- Filters and search -->
                    <form method="GET" class="mb-4">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select name="doc_type" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">All types</option>
                                    {% for code, name, icon, color in document_types %}
                                        <option value="{{ code }}" {% if filter_type == code %}selected{% endif %}>{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">All years</option>
                                    {% for y in years %}
                                        <option value="{{ y }}" {% if filter_year == y %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" name="search" placeholder="Search..."
                                           value="{{ search or '' }}">
                                    <button class="btn btn-outline-secondary" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <a href="{{ url_for('reminders.detail', reminder_id=reminder.id) }}" class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="fas fa-redo"></i>
                                </a>
                            </div>
                        </div>
                    </form>

                    <!-- Document list -->
                    {% if documents %}
                        {% set current_year = namespace(value=None) %}
                        {% for document in documents %}
                            {% if document.year and document.year != current_year.value %}
                                {% set current_year.value = document.year %}
                                <div class="year-separator">
                                    <i class="fas fa-calendar-alt"></i> {{ document.year }}
                                </div>
                            {% endif %}

                            {% set doc_info = get_document_type_info(document.document_type) %}
                            <div class="card document-card {{ document.document_type }} mb-2">
                                <div class="card-body py-2 px-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="width: 40px; text-align: center;">
                                            <i class="fas {{ doc_info.icon }} fa-lg" style="color: {{ doc_info.color }};"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <strong>{{ document.name }}</strong>
                                                <span class="badge doc-type-badge ms-2" style="background-color: {{ doc_info.color }};">
                                                    {{ doc_info.name }}
                                                </span>
                                                {% if document.month %}
                                                    <span class="badge bg-light text-dark ms-2">
                                                        {{ ['', 'Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'][document.month] }} {{ document.year }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            {% if document.description %}
                                                <small class="text-muted">{{ document.description[:80] }}{% if document.description|length > 80 %}...{% endif %}</small>
                                            {% endif %}
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    {% if document.file_name %}
                                                        <i class="fas fa-paperclip"></i> {{ document.file_name }} ({{ document.get_file_size_display() }})
                                                    {% endif %}
                                                    {% if document.document_date %}
                                                        <span class="ms-2"><i class="fas fa-calendar"></i> {{ document.document_date.strftime('%d/%m/%Y') }}</span>
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        <div class="btn-group">
                                            {% if document.file_data %}
                                                {% if document.file_mime_type and (document.file_mime_type.startswith('application/pdf') or document.file_mime_type.startswith('image/')) %}
                                                    <button type="button"
                                                       class="btn btn-sm btn-outline-primary"
                                                       onclick="openPreviewModal('{{ url_for('reminders.view_document', document_id=document.id) }}', '{{ document.name | e }}', '{{ document.file_mime_type }}')"
                                                       title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                {% endif %}
                                                <a href="{{ url_for('reminders.download_document', document_id=document.id) }}"
                                                   class="btn btn-sm btn-outline-success" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            {% endif %}
                                            <a href="{{ url_for('reminders.edit_document', document_id=document.id) }}"
                                               class="btn btn-sm btn-outline-warning" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('reminders.delete_document', document_id=document.id) }}"
                                                  onsubmit="return confirm('Delete this document?')" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                            <h5>No documents</h5>
                            <p class="text-muted">
                                {% if filter_type or filter_year or search %}
                                    No documents match the search criteria.
                                {% else %}
                                    Add your invoices, contracts and other documents related to this service.
                                {% endif %}
                            </p>
                            <a href="{{ url_for('reminders.add_document', reminder_id=reminder.id) }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add document
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document preview modal -->
<div class="modal fade document-preview-modal" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentPreviewModalLabel">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="previewDocName">Document</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="documentPreviewContent">
                <!-- Content will be inserted dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
function openPreviewModal(docUrl, docName, docType) {
    const modalElement = document.getElementById('documentPreviewModal');
    const previewContent = document.getElementById('documentPreviewContent');
    const previewDocName = document.getElementById('previewDocName');

    // Update title
    previewDocName.textContent = docName;

    // Determine content type
    if (docType.startsWith('application/pdf')) {
        previewContent.innerHTML = '<embed src="' + docUrl + '" type="application/pdf" />';
    } else if (docType.startsWith('image/')) {
        previewContent.innerHTML = '<div class="preview-image-container"><img src="' + docUrl + '" alt="' + docName + '" /></div>';
    } else {
        previewContent.innerHTML = '<div class="text-center p-5"><i class="fas fa-file fa-4x text-muted mb-3"></i><p>Preview not available for this file type</p><a href="' + docUrl + '" target="_blank" class="btn btn-primary">Open in new tab</a></div>';
    }

    // Use standard Bootstrap API
    var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
    modal.show();
}

// Cleanup when modal is closed
document.getElementById('documentPreviewModal').addEventListener('hidden.bs.modal', function() {
    // Clear content
    document.getElementById('documentPreviewContent').innerHTML = '';

    // Force cleanup after a short delay
    setTimeout(function() {
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        document.querySelectorAll('.modal-backdrop').forEach(function(el) {
            el.remove();
        });
    }, 150);
});
</script>
{% endblock %}
