{% extends "base.html" %}

{% block title %}{{ _('Télécharger des tickets CB') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-robot"></i> {{ _('Scanner des tickets avec OCR') }}</h2>
                <a href="{{ url_for('card_purchases.list_purchases') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> {{ _('Retour') }}
                </a>
            </div>

            <!-- Navigation between modes -->
            <div class="alert alert-light border">
                <div class="d-flex gap-2">
                    <a href="{{ url_for('card_purchases.add_manual') }}" class="btn btn-outline-primary">
                        <i class="fas fa-keyboard"></i> {{ _('Saisie manuelle') }}
                    </a>
                    <a href="{{ url_for('card_purchases.upload_receipts') }}" class="btn btn-primary">
                        <i class="fas fa-robot"></i> {{ _('Scanner avec OCR') }}
                    </a>
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle"></i> {{ _('Vous pouvez saisir manuellement ou utiliser l\'OCR pour scanner vos tickets') }}
                </small>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="receipts" class="form-label">
                                <i class="fas fa-images"></i> {{ _('Sélectionner des tickets (jusqu\'à 10)') }}
                            </label>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <input type="file"
                                       class="d-none"
                                       id="receipts"
                                       name="receipts"
                                       multiple
                                       required
                                       accept="image/*,.pdf">
                                <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('receipts').click()">
                                    <i class="fas fa-folder-open"></i> {{ _('Parcourir...') }}
                                </button>
                                <span id="file-count-display" class="text-muted flex-grow-1">{{ _('Aucun fichier sélectionné') }}</span>
                            </div>
                            <small class="text-muted">
                                {{ _('Formats acceptés : JPG, PNG, PDF. Maximum 5 Mo par fichier.') }}
                            </small>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>{{ _('Comment ça fonctionne ?') }}</strong><br>
                            {{ _('1. Sélectionnez vos photos/scans de tickets de caisse') }}<br>
                            {{ _('2. Le système extraira automatiquement les données (date, montant, marchand)') }}<br>
                            {{ _('3. Vous pourrez vérifier et corriger les données avant validation') }}<br>
                            {{ _('4. Les achats seront ajoutés à votre solde') }}
                        </div>

                        <div id="preview" class="mb-3"></div>

                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-robot"></i> {{ _('Traiter avec OCR') }}
                        </button>
                        <div id="loadingIndicator" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                    <strong>{{ _('Traitement OCR en cours...') }}</strong>
                                </div>
                                <small>{{ _('Cela peut prendre quelques secondes par fichier. Veuillez patienter.') }}</small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const i18n = {
    noFilesSelected: "{{ _('Aucun fichier sélectionné') }}",
    filesSelected: "{{ _('fichier(s) sélectionné(s)') }}",
    maxFilesWarning: "{{ _('Maximum 10 fichiers. Seuls les 10 premiers seront traités.') }}"
};

document.getElementById('receipts').addEventListener('change', function() {
    const preview = document.getElementById('preview');
    const submitBtn = document.getElementById('submitBtn');
    const fileCountDisplay = document.getElementById('file-count-display');
    const files = this.files;

    preview.innerHTML = '';

    if (files.length > 0) {
        submitBtn.disabled = false;

        // Update file count display
        fileCountDisplay.textContent = `${files.length} ${i18n.filesSelected}`;
        fileCountDisplay.classList.remove('text-muted');
        fileCountDisplay.classList.add('text-success', 'fw-bold');

        const badge = document.createElement('div');
        badge.className = 'alert alert-success';
        badge.innerHTML = `<i class="fas fa-check-circle"></i> ${files.length} ${i18n.filesSelected}`;
        preview.appendChild(badge);

        if (files.length > 10) {
            badge.className = 'alert alert-warning';
            badge.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${i18n.maxFilesWarning}`;
        }
    } else {
        submitBtn.disabled = true;
        fileCountDisplay.textContent = i18n.noFilesSelected;
        fileCountDisplay.classList.remove('text-success', 'fw-bold');
        fileCountDisplay.classList.add('text-muted');
    }
});

// Show loading indicator on submission
document.querySelector('form').addEventListener('submit', function() {
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('loadingIndicator').style.display = 'block';
});
</script>
{% endblock %}
