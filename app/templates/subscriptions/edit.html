{% extends "base.html" %}

{% block title %}{{ _('Modifier %(name)s', name=subscription.name) }} - Budgee Family{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-edit subscription-blue-icon"></i> {{ _('Modifier l\'abonnement') }}</h2>
                <a href="{{ url_for('subscriptions.list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> {{ _('Retour') }}
                </a>
            </div>

            <div class="card">
                <div class="card-body p-4">
                    <form method="POST">
                        <div class="mb-3">
                            <label for="service_id" class="form-label">{{ _('Service (optionnel)') }}</label>
                            <select class="form-select" id="service_id" name="service_id" onchange="updateFromService()">
                                <option value="">{{ _('-- Saisie manuelle --') }}</option>
                                {% if services %}
                                    {% for service in services %}
                                        <option value="{{ service.id }}"
                                                data-name="{{ service.name }}"
                                                data-category="{{ service.category_id or '' }}"
                                                {% if subscription.service_id == service.id %}selected{% endif %}>
                                            {{ service.name }}
                                        </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <small class="text-muted">{{ _('Sélectionnez un service pour pré-remplir les informations') }}</small>
                        </div>

                        <div id="plan-selector" class="mb-3" style="display: none;">
                            <label for="plan_select" class="form-label">{{ _('Formule') }}</label>
                            <select class="form-select" id="plan_select" onchange="updateFromPlan()">
                                <option value="">{{ _('-- Choisir une formule --') }}</option>
                            </select>
                            <small class="text-muted">{{ _('Sélectionnez une formule pour remplir automatiquement le montant') }}</small>
                        </div>

                        <input type="hidden" id="plan_id" name="plan_id" value="{{ subscription.plan_id or '' }}">

                        <div class="mb-3">
                            <label for="name" class="form-label">{{ _('Nom de l\'abonnement') }} *</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   value="{{ subscription.name }}">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">{{ _('Description') }}</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ subscription.description or '' }}</textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="amount_display" class="form-label">{{ _('Montant') }} *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-end" id="amount_display"
                                           required placeholder="9,99">
                                    <input type="hidden" id="amount" name="amount" value="{{ subscription.amount }}">
                                    <select class="form-select" id="currency" name="currency" style="max-width: 100px;">
                                        <option value="EUR" {% if subscription.currency == 'EUR' %}selected{% endif %}>€ EUR</option>
                                        <option value="USD" {% if subscription.currency == 'USD' %}selected{% endif %}>$ USD</option>
                                        <option value="GBP" {% if subscription.currency == 'GBP' %}selected{% endif %}>£ GBP</option>
                                    </select>
                                </div>
                                <small class="text-muted">{{ _('Format : espace pour les milliers, virgule pour les décimales') }}</small>
                            </div>

                            <div class="col-md-6">
                                <label for="billing_cycle" class="form-label">{{ _('Périodicité') }} *</label>
                                <select class="form-select" id="billing_cycle" name="billing_cycle" required>
                                    <option value="weekly" {% if subscription.billing_cycle == 'weekly' %}selected{% endif %}>{{ _('Hebdomadaire') }}</option>
                                    <option value="monthly" {% if subscription.billing_cycle == 'monthly' %}selected{% endif %}>{{ _('Mensuel') }}</option>
                                    <option value="quarterly" {% if subscription.billing_cycle == 'quarterly' %}selected{% endif %}>{{ _('Trimestriel') }}</option>
                                    <option value="yearly" {% if subscription.billing_cycle == 'yearly' %}selected{% endif %}>{{ _('Annuel') }}</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="category_id" class="form-label">{{ _('Catégorie') }}</label>
                            <select class="form-select" id="category_id" name="category_id">
                                <option value="">{{ _('Aucune catégorie') }}</option>
                                {% for category in categories %}
                                    <option value="{{ category.id }}"
                                            {% if subscription.category_id == category.id %}selected{% endif %}>
                                        {{ category | get_translated_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('subscriptions.list') }}" class="btn btn-outline-secondary">
                                {{ _('Annuler') }}
                            </a>
                            <button type="submit" class="btn btn-subscription">
                                <i class="fas fa-save"></i> {{ _('Enregistrer les modifications') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Formatage du montant avec espace pour milliers et virgule pour décimales
const amountDisplay = document.getElementById('amount_display');
const amountHidden = document.getElementById('amount');

function formatAmountInput(value) {
    // Enlever tout sauf les chiffres, virgules et points
    let cleaned = value.replace(/[^\d,\.]/g, '');

    // Remplacer le point par une virgule
    cleaned = cleaned.replace('.', ',');

    // S'assurer qu'il n'y a qu'une seule virgule
    const parts = cleaned.split(',');
    if (parts.length > 2) {
        cleaned = parts[0] + ',' + parts.slice(1).join('');
    }

    // Séparer la partie entière et décimale
    const [integerPart, decimalPart] = cleaned.split(',');

    // Formater la partie entière avec des espaces pour les milliers
    let formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');

    // Ajouter la partie décimale si elle existe
    if (decimalPart !== undefined) {
        formatted += ',' + decimalPart.substring(0, 2); // Limiter à 2 décimales
    }

    return formatted;
}

function unformatAmount(value) {
    // Enlever les espaces et remplacer la virgule par un point
    return value.replace(/\s/g, '').replace(',', '.');
}

amountDisplay.addEventListener('input', function(e) {
    const cursorPosition = e.target.selectionStart;
    const oldLength = e.target.value.length;

    // Formater la valeur
    const formatted = formatAmountInput(e.target.value);
    e.target.value = formatted;

    // Convertir et stocker dans le champ caché
    const unformatted = unformatAmount(formatted);
    amountHidden.value = unformatted;

    // Ajuster la position du curseur
    const newLength = formatted.length;
    const diff = newLength - oldLength;
    e.target.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
});

// Initialiser le champ display avec la valeur formatée
if (amountHidden.value) {
    amountDisplay.value = formatAmountInput(amountHidden.value);
}

// Fonction pour formater les montants au format français (pour affichage)
function formatAmount(amount) {
    const formatted = amount.toFixed(2);
    const parts = formatted.split('.');
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    return parts.join(',');
}

// Données des services avec leurs plans
const servicesData = {{ services|tojson|safe }};
console.log('Services data loaded:', servicesData);

// Traduction des cycles de facturation
const cycleTranslations = {
    'weekly': "{{ _('Hebdomadaire') }}",
    'monthly': "{{ _('Mensuel') }}",
    'quarterly': "{{ _('Trimestriel') }}",
    'yearly': "{{ _('Annuel') }}"
};

// Symboles de devises
const currencySymbols = {
    'EUR': '€',
    'USD': '$',
    'GBP': '£'
};

// Gestion de la sélection de service
function updateFromService() {
    const serviceSelect = document.getElementById('service_id');
    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
    const planSelector = document.getElementById('plan-selector');
    const planSelect = document.getElementById('plan_select');

    if (serviceSelect.value) {
        const serviceId = parseInt(serviceSelect.value);

        // Trouver le service dans les données
        const service = servicesData.find(s => s.id === serviceId);

        if (!service) {
            console.error('Service not found:', serviceId);
            return;
        }

        console.log('Service selected:', service);

        // Pré-remplir le nom
        document.getElementById('name').value = service.name;

        // Pré-sélectionner la catégorie
        if (service.category_id) {
            document.getElementById('category_id').value = service.category_id;
        }

        // Charger les formules
        const plans = service.plans || [];
        console.log('Plans found:', plans);

        planSelect.innerHTML = '<option value="">{{ _("-- Choisir une formule --") }}</option>';

        let activePlansCount = 0;
        plans.forEach(plan => {
            if (plan.is_active) {
                const option = document.createElement('option');
                option.value = plan.id;
                option.setAttribute('data-amount', plan.amount);
                option.setAttribute('data-currency', plan.currency);
                option.setAttribute('data-cycle', plan.billing_cycle);

                // Affichage avec traduction française
                const currencySymbol = currencySymbols[plan.currency] || plan.currency;
                const cycleLabel = cycleTranslations[plan.billing_cycle] || plan.billing_cycle;
                option.textContent = `${plan.name} - ${formatAmount(plan.amount)} ${currencySymbol} / ${cycleLabel}`;

                planSelect.appendChild(option);
                activePlansCount++;
            }
        });

        if (activePlansCount > 0) {
            console.log('Showing plan selector with', activePlansCount, 'plans');
            planSelector.style.display = 'block';
        } else {
            console.log('No active plans found');
            planSelector.style.display = 'none';
        }
    } else {
        // Réinitialiser
        console.log('Service deselected, resetting form');
        planSelector.style.display = 'none';
        planSelect.innerHTML = '<option value="">{{ _("-- Choisir une formule --") }}</option>';
        document.getElementById('plan_id').value = '';
    }
}

// Gestion de la sélection de formule
function updateFromPlan() {
    const planSelect = document.getElementById('plan_select');
    const selectedOption = planSelect.options[planSelect.selectedIndex];

    if (planSelect.value) {
        const amount = selectedOption.getAttribute('data-amount');
        const currency = selectedOption.getAttribute('data-currency');
        const cycle = selectedOption.getAttribute('data-cycle');

        console.log('Plan selected:', {
            id: planSelect.value,
            amount: amount,
            currency: currency,
            cycle: cycle
        });

        // Mettre à jour le champ caché plan_id
        document.getElementById('plan_id').value = planSelect.value;

        if (amount) {
            document.getElementById('amount').value = parseFloat(amount).toFixed(2);
            console.log('Amount set to:', parseFloat(amount).toFixed(2));
        }
        if (currency) {
            document.getElementById('currency').value = currency;
            console.log('Currency set to:', currency);
        }
        if (cycle) {
            document.getElementById('billing_cycle').value = cycle;
            console.log('Billing cycle set to:', cycle);
        }
    } else {
        console.log('Plan deselected');
        document.getElementById('plan_id').value = '';
    }
}

// Charger les plans du service sélectionné au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('service_id');
    const currentPlanId = document.getElementById('plan_id').value;

    console.log('Page loaded with service_id:', serviceSelect.value, 'and plan_id:', currentPlanId);

    if (serviceSelect.value) {
        updateFromService();

        // Attendre un peu que les plans soient chargés, puis pré-sélectionner le plan actuel
        setTimeout(function() {
            const planSelect = document.getElementById('plan_select');
            if (currentPlanId && planSelect) {
                console.log('Trying to pre-select plan:', currentPlanId);
                planSelect.value = currentPlanId;

                // Vérifier si la sélection a fonctionné
                if (planSelect.value === currentPlanId) {
                    console.log('Plan pre-selected successfully');
                } else {
                    console.log('Failed to pre-select plan');
                }
            }
        }, 100);
    }
});

// Protection contre les doubles soumissions et validation
document.querySelector('form').addEventListener('submit', function(e) {
    // Vérifier que le montant est valide
    const unformatted = unformatAmount(amountDisplay.value);
    if (!unformatted || isNaN(parseFloat(unformatted)) || parseFloat(unformatted) <= 0) {
        e.preventDefault();
        alert("{{ _('Veuillez entrer un montant valide') }}");
        return false;
    }

    // S'assurer que le champ caché a la bonne valeur
    amountHidden.value = unformatted;
});
</script>
{% endblock %}
