{% extends "base.html" %}

{% block title %}{{ _('Créer une catégorie') }} - Budgee Family{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-plus"></i> {{ _('Créer une catégorie') }}</h2>
                <a href="{{ url_for('categories.list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> {{ _('Retour') }}
                </a>
            </div>

            <div class="card">
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="name" class="form-label">{{ _('Nom de la catégorie') }} *</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   placeholder="{{ _('Ex: Abonnements Professionnels, Services Cloud...') }}">
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">{{ _('Description') }}</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      placeholder="{{ _('Description courte de cette catégorie') }}"></textarea>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="color" class="form-label">{{ _('Couleur') }}</label>
                                <div class="input-group">
                                    <input type="color" class="form-control form-control-color" id="color"
                                           name="color" value="#6c757d" title="{{ _('Choisir une couleur') }}">
                                    <input type="text" class="form-control" id="color-text" value="#6c757d"
                                           placeholder="#6c757d" maxlength="7">
                                </div>
                                <small class="text-muted">{{ _('Couleur utilisée pour identifier la catégorie') }}</small>
                            </div>

                            <div class="col-md-6">
                                <label for="icon" class="form-label">
                                    {{ _('Icône') }}
                                </label>
                                <input type="hidden" id="icon" name="icon" value="">
                                <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#iconPickerModal">
                                    <i class="fas fa-tag" id="selected-icon"></i>
                                    <span id="selected-icon-text">{{ _('Choisir une icône') }}</span>
                                </button>
                                <small class="text-muted">{{ _('Cliquez pour sélectionner une icône') }}</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="logo" class="form-label">{{ _('Logo') }} ({{ _('optionnel') }})</label>
                            <div class="custom-file-input-wrapper">
                                <label for="logo" class="custom-file-button btn btn-outline-secondary w-100">
                                    <i class="fas fa-upload me-2"></i>
                                    <span id="file-label">{{ _('Aucun fichier sélectionné') }}</span>
                                </label>
                                <input type="file" class="d-none" id="logo" name="logo"
                                       accept="image/png,image/jpeg,image/jpg,image/gif,image/svg+xml,image/webp">
                            </div>
                            <small class="text-muted">{{ _('Formats acceptés : PNG, JPG, GIF, SVG, WebP (max 5 MB)') }}</small>
                        </div>

                        <div class="mb-3">
                            <label for="website_url" class="form-label">{{ _('Site web') }} ({{ _('optionnel') }})</label>
                            <input type="url" class="form-control" id="website_url" name="website_url"
                                   placeholder="https://example.com">
                            <small class="text-muted">{{ _('URL du site web associé à cette catégorie') }}</small>
                        </div>

                        <!-- Prévisualisation -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="mb-3">{{ _('Prévisualisation') }}</h6>
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle p-3 me-3" id="preview-icon-container"
                                         style="background-color: #6c757d20; border: 2px solid #6c757d">
                                        <i class="fas fa-tag fa-2x" id="preview-icon" style="color: #6c757d"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-0" id="preview-name">{{ _('Nom de la catégorie') }}</h5>
                                        <small class="text-muted">{{ _('Catégorie personnalisée') }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('categories.list') }}" class="btn btn-outline-secondary">
                                {{ _('Annuler') }}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> {{ _('Créer la catégorie') }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de sélection d'icône -->
<div class="modal fade" id="iconPickerModal" tabindex="-1" aria-labelledby="iconPickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="iconPickerModalLabel">{{ _('Choisir une icône') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="icon-search" placeholder="{{ _('Rechercher une icône...') }}">
                <div class="row g-2" id="icon-grid">
                    <!-- Les icônes seront générées par JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.custom-file-input-wrapper {
    display: block;
}

.custom-file-button {
    cursor: pointer;
    text-align: left;
    padding: 0.375rem 0.75rem;
    transition: all 0.15s ease-in-out;
}

.custom-file-button:hover {
    background-color: #e9ecef;
}

.custom-file-button #file-label {
    color: #6c757d;
}

.custom-file-button.has-file #file-label {
    color: #212529;
    font-weight: 500;
}
</style>

<script>
// Gestion du label de fichier personnalisé
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('logo');
    const fileLabel = document.getElementById('file-label');
    const fileButton = document.querySelector('.custom-file-button');

    if (fileInput && fileLabel && fileButton) {
        fileInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                fileLabel.textContent = this.files[0].name;
                fileButton.classList.add('has-file');
            } else {
                fileLabel.textContent = "{{ _('Aucun fichier sélectionné') }}";
                fileButton.classList.remove('has-file');
            }
        });
    }
});

// Liste des icônes Font Awesome courantes
const icons = [
    // Général
    'fas fa-star', 'fas fa-heart', 'fas fa-tag', 'fas fa-bookmark', 'fas fa-flag',
    // Business
    'fas fa-briefcase', 'fas fa-building', 'fas fa-chart-line', 'fas fa-dollar-sign', 'fas fa-coins',
    // Technologie
    'fas fa-laptop', 'fas fa-mobile-alt', 'fas fa-desktop', 'fas fa-server', 'fas fa-database',
    'fas fa-code', 'fas fa-terminal', 'fas fa-microchip', 'fas fa-wifi', 'fas fa-cloud',
    // Média
    'fas fa-music', 'fas fa-film', 'fas fa-camera', 'fas fa-video', 'fas fa-headphones',
    'fas fa-play-circle', 'fas fa-tv', 'fas fa-gamepad', 'fas fa-podcast', 'fas fa-photo-video',
    // Shopping
    'fas fa-shopping-cart', 'fas fa-shopping-bag', 'fas fa-credit-card', 'fas fa-receipt', 'fas fa-cash-register',
    // Communication
    'fas fa-envelope', 'fas fa-comment', 'fas fa-comments', 'fas fa-phone', 'fas fa-fax',
    'fas fa-inbox', 'fas fa-paper-plane', 'fas fa-bell', 'fas fa-globe', 'fas fa-broadcast-tower',
    // Education
    'fas fa-book', 'fas fa-graduation-cap', 'fas fa-university', 'fas fa-pen', 'fas fa-pencil-alt',
    'fas fa-ruler', 'fas fa-calculator', 'fas fa-flask', 'fas fa-atom', 'fas fa-microscope',
    // Santé
    'fas fa-heartbeat', 'fas fa-hospital', 'fas fa-stethoscope', 'fas fa-pills', 'fas fa-syringe',
    'fas fa-dumbbell', 'fas fa-running', 'fas fa-bicycle', 'fas fa-apple-alt', 'fas fa-medkit',
    // Transport
    'fas fa-car', 'fas fa-bus', 'fas fa-train', 'fas fa-plane', 'fas fa-ship',
    'fas fa-motorcycle', 'fas fa-truck', 'fas fa-taxi', 'fas fa-subway', 'fas fa-rocket',
    // Maison
    'fas fa-home', 'fas fa-key', 'fas fa-door-open', 'fas fa-couch', 'fas fa-bed',
    'fas fa-utensils', 'fas fa-coffee', 'fas fa-pizza-slice', 'fas fa-blender', 'fas fa-lightbulb',
    // Nature
    'fas fa-tree', 'fas fa-leaf', 'fas fa-seedling', 'fas fa-sun', 'fas fa-moon',
    'fas fa-cloud-sun', 'fas fa-rainbow', 'fas fa-paw', 'fas fa-dog', 'fas fa-cat',
    // Outils
    'fas fa-tools', 'fas fa-wrench', 'fas fa-hammer', 'fas fa-screwdriver', 'fas fa-cog',
    'fas fa-cogs', 'fas fa-sliders-h', 'fas fa-paint-brush', 'fas fa-palette', 'fas fa-drafting-compass',
    // Sport
    'fas fa-football-ball', 'fas fa-basketball-ball', 'fas fa-baseball-ball', 'fas fa-volleyball-ball', 'fas fa-bowling-ball',
    'fas fa-table-tennis', 'fas fa-hockey-puck', 'fas fa-golf-ball', 'fas fa-futbol', 'fas fa-trophy',
    // Météo
    'fas fa-snowflake', 'fas fa-cloud-rain', 'fas fa-bolt', 'fas fa-wind', 'fas fa-water',
    // Symboles
    'fas fa-crown', 'fas fa-gem', 'fas fa-gift', 'fas fa-award', 'fas fa-medal',
    'fas fa-shield-alt', 'fas fa-lock', 'fas fa-unlock', 'fas fa-check-circle', 'fas fa-times-circle',
    // Médias sociaux
    'fab fa-facebook', 'fab fa-twitter', 'fab fa-instagram', 'fab fa-youtube', 'fab fa-linkedin',
    'fab fa-github', 'fab fa-spotify', 'fab fa-netflix', 'fab fa-amazon', 'fab fa-google',
    // Divers
    'fas fa-user', 'fas fa-users', 'fas fa-user-tie', 'fas fa-baby', 'fas fa-child',
    'fas fa-map-marker-alt', 'fas fa-compass', 'fas fa-calendar', 'fas fa-clock', 'fas fa-hourglass'
];

// Générer la grille d'icônes
const iconGrid = document.getElementById('icon-grid');
icons.forEach(iconClass => {
    const col = document.createElement('div');
    col.className = 'col-2 col-md-1';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'btn btn-outline-secondary w-100 p-2 icon-btn';
    btn.setAttribute('data-icon', iconClass);
    btn.title = iconClass;

    const icon = document.createElement('i');
    icon.className = iconClass + ' fa-2x';

    btn.appendChild(icon);
    col.appendChild(btn);
    iconGrid.appendChild(col);
});

// Recherche d'icônes
const iconSearch = document.getElementById('icon-search');
iconSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const iconButtons = document.querySelectorAll('.icon-btn');

    iconButtons.forEach(btn => {
        const iconClass = btn.getAttribute('data-icon');
        if (iconClass.toLowerCase().includes(searchTerm)) {
            btn.parentElement.style.display = 'block';
        } else {
            btn.parentElement.style.display = 'none';
        }
    });
});

// Sélection d'icône
document.querySelectorAll('.icon-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const iconClass = this.getAttribute('data-icon');
        document.getElementById('icon').value = iconClass;
        document.getElementById('selected-icon').className = iconClass;
        document.getElementById('selected-icon-text').textContent = ' ' + iconClass;

        // Fermer la modale
        const modal = bootstrap.Modal.getInstance(document.getElementById('iconPickerModal'));
        modal.hide();

        // Mettre à jour la prévisualisation
        previewIcon.className = iconClass + ' fa-2x';
    });
});

// Prévisualisation en temps réel
const nameInput = document.getElementById('name');
const colorInput = document.getElementById('color');
const colorTextInput = document.getElementById('color-text');
const iconInput = document.getElementById('icon');
const previewName = document.getElementById('preview-name');
const previewIcon = document.getElementById('preview-icon');
const previewIconContainer = document.getElementById('preview-icon-container');

nameInput.addEventListener('input', () => {
    previewName.textContent = nameInput.value || "{{ _('Nom de la catégorie') }}";
});

colorInput.addEventListener('input', () => {
    const color = colorInput.value;
    colorTextInput.value = color;
    previewIcon.style.color = color;
    previewIconContainer.style.borderColor = color;
    previewIconContainer.style.backgroundColor = color + '20';
});

colorTextInput.addEventListener('input', () => {
    const color = colorTextInput.value;
    if (/^#[0-9A-F]{6}$/i.test(color)) {
        colorInput.value = color;
        previewIcon.style.color = color;
        previewIconContainer.style.borderColor = color;
        previewIconContainer.style.backgroundColor = color + '20';
    }
});
</script>
{% endblock %}
