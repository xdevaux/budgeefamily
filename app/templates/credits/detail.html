{% extends "base.html" %}

{% block title %}{{ credit.name }} - Budgee Family{% endblock %}

{% block extra_css %}
<style>
    .document-card {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
    }
    .document-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .document-card.contract { border-left-color: #6366f1; }
    .document-card.statement { border-left-color: #10b981; }
    .document-card.insurance { border-left-color: #f59e0b; }
    .document-card.amendment { border-left-color: #8b5cf6; }
    .document-card.correspondence { border-left-color: #06b6d4; }
    .document-card.other { border-left-color: #6c757d; }

    .doc-stats-card {
        cursor: pointer;
        transition: all 0.2s;
    }
    .doc-stats-card:hover {
        transform: scale(1.02);
    }
    .doc-stats-card.active {
        border: 2px solid #6366f1;
    }

    /* Styles pour la modal de preview */
    .document-preview-modal .modal-dialog {
        max-width: 80%;
        max-height: 90vh;
        margin: 2rem auto;
    }
    .document-preview-modal .modal-content {
        height: 85vh;
        border-radius: 12px;
        overflow: hidden;
    }
    .document-preview-modal .modal-header {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
    }
    .document-preview-modal .modal-header .btn-close {
        filter: brightness(0) invert(1);
        opacity: 0.8;
    }
    .document-preview-modal .modal-header .btn-close:hover {
        opacity: 1;
    }
    .document-preview-modal .modal-body {
        padding: 0;
        height: calc(100% - 56px);
        overflow: hidden;
        background: #f8f9fa;
    }
    .document-preview-modal .modal-body iframe,
    .document-preview-modal .modal-body embed {
        width: 100%;
        height: 100%;
        border: none;
    }
    .document-preview-modal .modal-body img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: block;
        margin: auto;
    }
    .preview-image-container {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 1rem;
        background: #2d2d2d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-money-bill-wave"></i> {{ credit.name }}</h2>
        <div class="btn-group">
            <a href="{{ url_for('credits.edit', credit_id=credit.id) }}" class="btn btn-warning">
                <i class="fas fa-edit"></i> Modifier
            </a>
            <a href="{{ url_for('credits.list_credits') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Retour
            </a>
        </div>
    </div>

    <!-- Informations principales -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Mensualité</h6>
                    <h2 class="mb-0">{{ credit.amount | format_amount }} {{ credit.currency | currency_symbol }}</h2>
                    <small class="text-muted">{{ credit.billing_cycle | translate_cycle }}</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Montant total</h6>
                    <h2 class="mb-0">
                        {% if credit.total_amount %}
                            {{ credit.total_amount | format_amount }} {{ credit.currency | currency_symbol }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </h2>
                    <small class="text-muted">Emprunté au départ</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h6 class="text-muted">Montant restant</h6>
                    <h2 class="mb-0">
                        {% if credit.remaining_amount %}
                            {{ credit.remaining_amount | format_amount }} {{ credit.currency | currency_symbol }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </h2>
                    <small class="text-muted">À rembourser</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Progression du remboursement -->
    {% if credit.total_amount and credit.remaining_amount %}
    <div class="card mb-4">
        <div class="card-header" style="background-color: #e5e7eb;">
            <h5 class="mb-0"><i class="fas fa-chart-line text-secondary"></i> Progression du remboursement</h5>
        </div>
        <div class="card-body">
            <div class="progress mb-3" style="height: 30px;">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: {{ credit.get_progress_percentage() }}%;"
                     aria-valuenow="{{ credit.get_progress_percentage() }}"
                     aria-valuemin="0" aria-valuemax="100">
                    {{ credit.get_progress_percentage() }}%
                </div>
            </div>
            <div class="row text-center">
                <div class="col">
                    <strong>Payé :</strong>
                    {{ (credit.total_amount - credit.remaining_amount) | format_amount }} {{ credit.currency | currency_symbol }}
                </div>
                <div class="col">
                    <strong>Restant :</strong>
                    {{ credit.remaining_amount | format_amount }} {{ credit.currency | currency_symbol }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Colonne informations -->
        <div class="col-lg-4">
            <!-- Détails du crédit -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-info-circle text-secondary"></i> Détails</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Type de crédit :</strong><br>
                        {% if credit.credit_type_obj %}
                            <span class="badge" style="background-color: {{ credit.credit_type_obj.color }};">
                                <i class="fas {{ credit.credit_type_obj.icon or 'fa-circle' }}"></i>
                                {{ credit.credit_type_obj.name }}
                            </span>
                        {% else %}
                            <span class="text-muted">Non défini</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>Banque :</strong><br>
                        {% if credit.bank %}
                            <span class="text-primary">
                                <i class="fas fa-university"></i> {{ credit.bank.name }}
                            </span>
                            {% if credit.bank.bic %}
                                <br><small class="text-muted">{{ credit.bank.bic }}</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Non renseignée</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>Statut :</strong><br>
                        {% if credit.is_active %}
                            <span class="badge bg-success">Actif</span>
                        {% else %}
                            <span class="badge bg-danger">Clôturé</span>
                        {% endif %}
                    </div>

                    {% if credit.description %}
                    <div class="mb-3">
                        <strong>Description :</strong><br>
                        <p class="mb-0">{{ credit.description }}</p>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <strong>Taux d'intérêt :</strong><br>
                        {% if credit.interest_rate %}
                            {{ credit.interest_rate }}%
                        {% else %}
                            <span class="text-muted">Non renseigné</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>Date de début :</strong><br>
                        {{ credit.start_date.strftime('%d/%m/%Y') }}
                    </div>

                    <div class="mb-3">
                        <strong>Date de fin prévue :</strong><br>
                        {% if credit.end_date %}
                            {{ credit.end_date.strftime('%d/%m/%Y') }}
                        {% else %}
                            <span class="text-muted">Non renseignée</span>
                        {% endif %}
                    </div>

                    <div class="mb-0">
                        <strong>Prochain paiement :</strong><br>
                        {{ credit.next_payment_date.strftime('%d/%m/%Y') }}
                    </div>
                </div>
            </div>

            <!-- Statistiques documents -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <i class="fas fa-chart-pie text-secondary"></i> Documents
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        {% for code, name, icon, color in document_types %}
                            <div class="col-6">
                                <a href="{{ url_for('credits.detail', credit_id=credit.id, doc_type=code) }}"
                                   class="card doc-stats-card text-decoration-none {% if filter_type == code %}active{% endif %}"
                                   style="border-left: 4px solid {{ color }};">
                                    <div class="card-body p-2 text-center">
                                        <i class="fas {{ icon }}" style="color: {{ color }};"></i>
                                        <div class="fw-bold">{{ doc_counts.get(code, 0) }}</div>
                                        <small class="text-muted">{{ name }}</small>
                                    </div>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header" style="background-color: #e5e7eb;">
                    <h5 class="mb-0"><i class="fas fa-cog text-secondary"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <form method="POST" action="{{ url_for('credits.toggle', credit_id=credit.id) }}">
                            <button type="submit" class="btn btn-info w-100">
                                <i class="fas fa-toggle-{% if credit.is_active %}on{% else %}off{% endif %}"></i>
                                {% if credit.is_active %}
                                    Marquer comme clôturé
                                {% else %}
                                    Réactiver
                                {% endif %}
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('credits.delete', credit_id=credit.id) }}"
                              onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce crédit ?')">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne documents -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #e5e7eb;">
                    <span>
                        <i class="fas fa-folder-open text-secondary"></i> Documents
                        {% if total_size > 0 %}
                            <span class="badge bg-info ms-2">
                                <i class="fas fa-hdd"></i>
                                {% if total_size >= 1073741824 %}
                                    {{ "%.2f"|format(total_size / 1073741824) }} Go
                                {% elif total_size >= 1048576 %}
                                    {{ "%.2f"|format(total_size / 1048576) }} Mo
                                {% elif total_size >= 1024 %}
                                    {{ "%.2f"|format(total_size / 1024) }} Ko
                                {% else %}
                                    {{ total_size }} octets
                                {% endif %}
                            </span>
                        {% endif %}
                    </span>
                    <a href="{{ url_for('credits.add_document', credit_id=credit.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Ajouter un document
                    </a>
                </div>
                <div class="card-body">
                    <!-- Filtres et recherche -->
                    <form method="GET" class="mb-4">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <select name="doc_type" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">Tous les types</option>
                                    {% for code, name, icon, color in document_types %}
                                        <option value="{{ code }}" {% if filter_type == code %}selected{% endif %}>{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select name="year" class="form-select form-select-sm" onchange="this.form.submit()">
                                    <option value="">Toutes les années</option>
                                    {% for y in years %}
                                        <option value="{{ y }}" {% if filter_year == y %}selected{% endif %}>{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" name="search" placeholder="Rechercher..."
                                           value="{{ search or '' }}">
                                    <button class="btn btn-outline-secondary" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <a href="{{ url_for('credits.detail', credit_id=credit.id) }}" class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="fas fa-redo"></i>
                                </a>
                            </div>
                        </div>
                    </form>

                    <!-- Liste des documents -->
                    {% if documents %}
                        <div class="list-group">
                            {% for document in documents %}
                                {% set doc_info = get_document_type_info(document.document_type) %}
                                <div class="list-group-item document-card {{ document.document_type }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas {{ doc_info.icon }} fa-2x me-3" style="color: {{ doc_info.color }};"></i>
                                                <div>
                                                    <h6 class="mb-0">{{ document.name }}</h6>
                                                    <small class="text-muted">
                                                        <span class="badge" style="background-color: {{ doc_info.color }};">{{ doc_info.name }}</span>
                                                        {% if document.document_date %}
                                                            • {{ document.document_date.strftime('%d/%m/%Y') }}
                                                        {% endif %}
                                                        {% if document.file_size %}
                                                            •
                                                            {% if document.file_size < 1024 %}
                                                                {{ document.file_size }} B
                                                            {% elif document.file_size < 1048576 %}
                                                                {{ "%.2f"|format(document.file_size / 1024) }} KB
                                                            {% else %}
                                                                {{ "%.2f"|format(document.file_size / 1048576) }} MB
                                                            {% endif %}
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            {% if document.description %}
                                                <p class="text-muted mb-0 small">{{ document.description }}</p>
                                            {% endif %}
                                        </div>
                                        <div class="btn-group">
                                            {% if document.file_data %}
                                                {% if document.file_mime_type and (document.file_mime_type.startswith('application/pdf') or document.file_mime_type.startswith('image/')) %}
                                                    <button type="button"
                                                       class="btn btn-sm btn-outline-primary"
                                                       onclick="openPreviewModal('{{ url_for('credits.view_document', document_id=document.id) }}', '{{ document.name | e }}', '{{ document.file_mime_type }}')"
                                                       title="Visualiser">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                {% else %}
                                                    <a href="{{ url_for('credits.view_document', document_id=document.id) }}"
                                                       class="btn btn-sm btn-outline-primary" title="Voir" target="_blank">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                {% endif %}
                                                <a href="{{ url_for('credits.download_document', document_id=document.id) }}"
                                                   class="btn btn-sm btn-outline-success" title="Télécharger">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            {% endif %}
                                            <a href="{{ url_for('credits.edit_document', document_id=document.id) }}"
                                               class="btn btn-sm btn-outline-warning" title="Modifier">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('credits.delete_document', document_id=document.id) }}"
                                                  onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce document ?')" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i>
                            {% if filter_type or filter_year or search %}
                                Aucun document ne correspond aux critères de recherche.
                            {% else %}
                                Aucun document ajouté pour ce crédit.
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de visualisation de document -->
<div class="modal fade document-preview-modal" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentPreviewModalLabel">
                    <i class="fas fa-file-alt me-2"></i>
                    <span id="previewDocName">Document</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body" id="documentPreviewContent">
                <!-- Le contenu sera inséré dynamiquement -->
            </div>
        </div>
    </div>
</div>

<script>
function openPreviewModal(docUrl, docName, docType) {
    const modalElement = document.getElementById('documentPreviewModal');
    const previewContent = document.getElementById('documentPreviewContent');
    const previewDocName = document.getElementById('previewDocName');

    // Mettre à jour le titre
    previewDocName.textContent = docName;

    // Déterminer le type de contenu
    if (docType.startsWith('application/pdf')) {
        previewContent.innerHTML = '<embed src="' + docUrl + '" type="application/pdf" />';
    } else if (docType.startsWith('image/')) {
        previewContent.innerHTML = '<div class="preview-image-container"><img src="' + docUrl + '" alt="' + docName + '" /></div>';
    } else {
        previewContent.innerHTML = '<div class="text-center p-5"><i class="fas fa-file fa-4x text-muted mb-3"></i><p>Aperçu non disponible pour ce type de fichier</p><a href="' + docUrl + '" target="_blank" class="btn btn-primary">Ouvrir dans un nouvel onglet</a></div>';
    }

    // Utiliser l'API Bootstrap standard
    var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
    modal.show();
}

// Nettoyage quand la modal est fermée
document.getElementById('documentPreviewModal').addEventListener('hidden.bs.modal', function() {
    // Vider le contenu
    document.getElementById('documentPreviewContent').innerHTML = '';

    // Nettoyage force après un court délai
    setTimeout(function() {
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        document.querySelectorAll('.modal-backdrop').forEach(function(el) {
            el.remove();
        });
    }, 150);
});
</script>
{% endblock %}
